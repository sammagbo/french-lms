generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  passwordHash      String            @map("password_hash")
  role              Role              @default(STUDENT)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdActivities Activity[]
  comments          Comment[]
  createdCourses    Course[]
  feedbacksGiven    Feedback[]
  posts             Post[]
  profile           Profile?
  studentActivities StudentActivity[]
  submissions       Submission[]

  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Profile {
  id          String   @id @default(uuid())
  bio         String?
  avatarUrl   String?
  frenchLevel String?
  userId      String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Course {
  id          String   @id @default(uuid())
  title       String
  description String?
  price       Float?   @default(0)
  slug        String   @unique
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id])
  modules     Module[]

  @@index([authorId])
  @@map("courses")
}

model Module {
  id        String   @id @default(uuid())
  title     String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lessons   Lesson[]
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("modules")
}

model Lesson {
  id         String     @id @default(uuid())
  title      String
  videoUrl   String?
  content    String?
  moduleId   String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  activities Activity[]
  module     Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("lessons")
}

model Activity {
  id                String            @id @default(uuid())
  title             String
  description       String?
  lessonId          String?
  authorId          String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  author            User              @relation(fields: [authorId], references: [id])
  lesson            Lesson?           @relation(fields: [lessonId], references: [id])
  studentActivities StudentActivity[]

  @@index([authorId])
  @@index([lessonId])
  @@map("activities")
}

model StudentActivity {
  id          String           @id @default(uuid())
  status      SubmissionStatus @default(PENDING)
  dueDate     DateTime?
  studentId   String
  activityId  String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  activity    Activity         @relation(fields: [activityId], references: [id])
  student     User             @relation(fields: [studentId], references: [id])
  submissions Submission[]

  @@index([studentId, status])
  @@index([status])
  @@index([activityId])
  @@index([studentId])
  @@map("student_activities")
}

model Submission {
  id                String          @id @default(uuid())
  textContent       String?
  attachmentUrl     String?
  studentActivityId String
  studentId         String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  feedback          Feedback?
  studentActivity   StudentActivity @relation(fields: [studentActivityId], references: [id])
  student           User            @relation(fields: [studentId], references: [id])

  @@index([studentActivityId])
  @@index([studentId])
  @@index([createdAt])
  @@map("submissions")
}

model Feedback {
  id               String     @id @default(uuid())
  grade            Float?
  comment          String?
  audioFeedbackUrl String?
  submissionId     String     @unique
  authorId         String
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  author           User       @relation(fields: [authorId], references: [id])
  submission       Submission @relation(fields: [submissionId], references: [id])

  @@map("feedbacks")
}

model Post {
  id        String    @id @default(uuid())
  title     String
  content   String
  published Boolean   @default(false)
  authorId  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  author    User      @relation(fields: [authorId], references: [id])

  @@index([authorId])
  @@map("posts")
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  postId    String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id])
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([authorId])
  @@map("comments")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
  RETURNED
}
